---
title: "SIMPlex_MB_cellbender"
output: html_document
date: "2023-09-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries and data

Load libraries

```{r package, message='hide',warning='hide',results='hold'}
suppressMessages(require(Seurat))
suppressMessages(require(SeuratDisk))
suppressMessages(require(Matrix))
suppressMessages(require(tidyverse))
suppressMessages(require(patchwork))
suppressMessages(require(ggplot2))
suppressMessages(require(harmony))
suppressMessages(require(DoubletFinder))
suppressMessages(require(scCustomize))
```

## Load cellbender data

```{r loaddata,message='hide',warning='hide',results='hold'}
# Load MB sample (cellbender processed)
MB_2_cellbender <- Read_CellBender_h5_Mat(file_name = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/cellbender_out/230426/230426_mb_cellbender_output_filtered.h5", use.names = TRUE)
MB_2 <- suppressWarnings(CreateSeuratObject(MB_2_cellbender,  project = "SIMPlex_MB"))
MB_2$sample <- "MB_2_simplex"

rm(MB_2_cellbender)
```

## Filter based on 10x CellRanger genes

```{r filtering,message='hide',warning='hide', results='hold',results='hold'}
MB_2_cellranger <- Seurat::Read10X_h5(
  filename = "/home/st-analysis_home/mengxiao.he/SIMPlex/cellranger_out/230426_sn_MOB_chromium/230425_sn_MOB_chromium_flex/outs/per_sample_outs/230425_sn_MOB_chromium_flex/count/sample_filtered_feature_bc_matrix.h5",
  use.names = T)
MB_2_cellranger <- CreateSeuratObject(MB_2_cellranger,  project = "SIMPlex_MB")
MB_2_cellranger$sample <- "MB_2"

MB_2_features <- rownames(MB_2_cellranger)
MB_2 <- subset(MB_2, features=MB_2_features)

rm(MB_2_cellranger, MB_2_features)
```

## Plot QC

```{r qcplot,message='hide', warning=FALSE, results='hold',results='hold',fig.height=8,fig.width=14}
feats <- c("nFeature_RNA","nCount_RNA")

p1 <- VlnPlot(MB_2, features = feats, pt.size = 0,ncol = 2) + NoLegend()
p2 <- ggplot() +
  geom_histogram(data = MB_2[[]], aes(nFeature_RNA), fill = "red", alpha = 0.7, bins = 100) +
  ggtitle("Unique genes per spot") + geom_vline(xintercept = 400, color = "black", linetype = "dashed")  + coord_flip()
p1 - p2
```

## Filtering (number of cells removed)

```{r qc_filtering,message='hide',warning='hide', results='hold',results='hold'}
selected_c <- WhichCells(MB_2, expression = nFeature_RNA > 400)
selected_f <- rownames(MB_2)[ Matrix::rowSums(MB_2) > 3]
MB_2.filt <- subset(MB_2, features=selected_f, cells=selected_c)

length(colnames(MB_2)) - length(colnames(MB_2.filt))
rm(MB_2)
```

## Normalize, PCA and Dim Elbow

```{r norm, warning=FALSE, results='hide'}
MB_2.filt <- SCTransform(MB_2.filt, vst.flavor="v2", verbose = FALSE)
MB_2.filt <- RunPCA(MB_2.filt, features = VariableFeatures(object = MB_2.filt), verbose = FALSE)
ElbowPlot(MB_2.filt, reduction = "pca", ndims = 50)
```

## UMAP

```{r umap, fig.height=8, fig.width=16}
MB_2.filt <- RunUMAP(MB_2.filt, dims = 1:30, verbose = FALSE)

DimPlot(MB_2.filt, reduction = 'umap', label = FALSE) + ggtitle("MB nuclei") + NoLegend()
FeaturePlot(MB_2.filt, reduction = "umap", features = c("nFeature_RNA", "nCount_RNA"))
```

## Predict dublets

```{r doubletfinder, message=FALSE, results='hide'}
# Run parameter optimization with paramSweep

# sweep.res <- paramSweep_v3(MB_2.filt, PCs = 1:30, sct = TRUE)
# sweep.stats <- summarizeSweep(sweep.res, GT = FALSE)
# bcmvn <- find.pK(sweep.stats)
# barplot(bcmvn$BCmetric, names.arg = bcmvn$pK, las=2)

# define the expected number of doublet cellscells.
nExp <- round(ncol(MB_2.filt)* 0.10)
MB_2.filt <- doubletFinder_v3(MB_2.filt, pN=0.25, pK = 0.05, nExp = nExp, PCs = 1:30, sct = TRUE)
```

## Visualize the doublet finder results

```{r DP.find, fig.height=6, fig.width=8}
DF.name = colnames(MB_2.filt@meta.data)[grepl("DF.classification", colnames(MB_2.filt@meta.data))]
DimPlot(MB_2.filt, group.by = DF.name) + NoAxes() + ggtitle("MB nuclei doublets prediction")
```

## Doublet removal

```{r filter.doublets}
#Filter data
MB_2.filt = MB_2.filt[,MB_2.filt@meta.data[,DF.name] == "Singlet"]
snMB <- MB_2.filt
rm(MB_2.filt)
```

## Normalize, highly variable features, scaling and PCA

```{r pre-proc, echo=FALSE, message=FALSE, warning='hide', results='hide'}
snMB <- SCTransform(snMB, vst.flavor="v2", verbose = FALSE)
snMB <- FindVariableFeatures(snMB, selection.method = "vst", verbose = FALSE)
all.genes <- rownames(snMB)
snMB <- ScaleData(snMB, features = all.genes, verbose = FALSE)
snMB <- RunPCA(snMB, features = VariableFeatures(object = snMB), verbose = FALSE)
```

## Dimensionality check

```{r elbow_plot_2}
ElbowPlot(snMB, reduction = "pca", ndims = 50)
```

## UMAP after duplicate removal

```{r umap_sample, fig.height=4, fig.width=, warning=FALSE, message=FALSE, error=FALSE}
snMB <- RunUMAP(snMB, dims = 1:30, verbose = FALSE)

DimPlot(snMB, reduction = "umap", group.by = "sample", label = FALSE) + ggtitle("MB SIMPlex") + NoLegend()
```

## Clustering

```{r,results='hide',block.title=TRUE,fig.height=10,fig.width=18}
snMB <- FindNeighbors(snMB, dims = 1:30, verbose = FALSE)
# Clustering with louvain (algorithm 1)
for (res in c( 0.1 , 0.25 , .5 , 0.8 , 1 , 1.25 )){
  snMB <- FindClusters(snMB, graph.name = "SCT_snn", resolution = res , algorithm = 1, verbose = FALSE)
}

d1 <- DimPlot(snMB, reduction = "umap", group.by = "SCT_snn_res.0.1", label = TRUE) + DimPlot(snMB, reduction = "umap", group.by = "SCT_snn_res.0.25", label = TRUE) + DimPlot(snMB, reduction = "umap", group.by = "SCT_snn_res.0.5", label = TRUE)
d2 <- DimPlot(snMB, reduction = "umap", group.by = "SCT_snn_res.0.8", label = TRUE) + DimPlot(snMB, reduction = "umap", group.by = "SCT_snn_res.1", label = TRUE) + DimPlot(snMB, reduction = "umap", group.by = "SCT_snn_res.1.25", label = TRUE)

d1 / d2
```

```{r cluster_harmony, fig.height=8, fig.width=10}
snMB <- FindClusters(snMB, verbose = FALSE)
DimPlot(snMB, reduction = "umap", group.by = "seurat_clusters", label = TRUE) + ggtitle("Cluster UMAP")
```

## Cluster markers

```{r markers, fig.height=8, fig.width=16}
sn.markers <- FindAllMarkers(snMB, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, verbose = FALSE)
sn.markers.top5 <- sn.markers %>% group_by(cluster) %>% slice_max(n = 5, order_by = avg_log2FC)
write.csv(sn.markers.top5, "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/MB_2_top5_markers_0.8.csv", row.names = FALSE)
```

## Cluster heatmap

```{r clusterHeatmap, fig.height=20, fig.width=20}
sn.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC) -> top5
DoHeatmap(snMB, features = top5$gene) + NoLegend()
```

## Dot plot
```{r dotplot, fig.height=14, fig.width=14}
#DotPlot(snMB.filt, features = rev(as.character(unique(top5$gene))), group.by = "seurat_clusters", assay = "RNA") + coord_flip()
Idents(snMB) <- snMB$seurat_clusters

AllMarkers.F <- sn.markers %>%
  filter(p_val_adj < 0.01)

top5CL <- AllMarkers.F %>%
  group_by(cluster) %>%
  top_n(wt = avg_log2FC, n = 5)

bro <- c("blue", "red")

DotPlot(snMB, 
        features = unique(top5CL$gene), 
        col.min = 0, 
        dot.min = 0, 
        dot.scale = 2, 
        cols = bro, 
        group.by = "seurat_clusters", 
        split.by = "sample") + 
  RotatedAxis() + 
  xlab('Marker genes') + 
  ylab('Samples') + 
  scale_y_discrete(limits=rev) + 
  scale_x_discrete(position = "top") + 
  theme(text = element_text(size = 10), 
        axis.text.x=element_text(size=3), 
        axis.text.y=element_text(size=5), 
        legend.direction="horizontal", 
        legend.position = "top")

# pdf(file = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/MB_2_cluster_dot_plot.pdf", height = 10, width = 50)
# DotPlot(snMB, 
#         features = unique(top5CL$gene), 
#         col.min = 0, 
#         dot.min = 0, 
#         dot.scale = 2, 
#         cols = bro, 
#         group.by = "seurat_clusters", 
#         split.by = "sample") + 
#   RotatedAxis() + 
#   xlab('Marker genes') + 
#   ylab('Samples') + 
#   scale_y_discrete(limits=rev) + 
#   scale_x_discrete(position = "top") + 
#   theme(text = element_text(size = 10), 
#         axis.text.x=element_text(size=6),
#         axis.text.x.top = element_text(margin = margin(b = 1), hjust = 0),
#         axis.text.y=element_text(size=8), 
#         legend.direction="horizontal", 
#         legend.position = "top")
# dev.off()
```

## Load scRNA public data (Mouse Brain Atlas from Linnarsson Lab)

```{r load_ref_data, warning=FALSE, message=FALSE, fig.height=15, fig.width=20}
mb_sc_ref.loom <- Connect(filename = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/public_mb_data/l5_all.loom", mode = "r")
mb_sc_ref <- as.Seurat(mb_sc_ref.loom)
mb_sc_ref.loom$close_all()
rm(mb_sc_ref.loom)

# Only keep cells of brain
mb_sc_ref <- SetIdent(mb_sc_ref, value = "Tissue")
mb_sc_ref <- subset(mb_sc_ref, idents = c("MBv", "Thal", "Pons", "Medulla", "SScortex", "StriatDor", "CB", "MBd", "Hypoth", "Ctx1", "StriatVent", "OB", "HC", "Ctx3", "Ctx2", "Amygd", "CA1", "DentGyr", "Ctx1.5"))

# perform standard preprocessing on each object
mb_sc_ref <- SCTransform(mb_sc_ref, vst.flavor="v2", verbose = FALSE)
mb_sc_ref <- FindVariableFeatures(mb_sc_ref, selection.method = "vst", verbose = FALSE)
all.genes <- rownames(mb_sc_ref)
mb_sc_ref <- ScaleData(mb_sc_ref, features = all.genes, verbose = FALSE)
mb_sc_ref <- RunPCA(mb_sc_ref, verbose = FALSE)
mb_sc_ref <- RunUMAP(mb_sc_ref, dims = 1:30, verbose = FALSE)

p1 <- DimPlot(mb_sc_ref, group.by = "Class", label = TRUE, repel = TRUE) + ggtitle("scRNA MB atlas data - Class")
p2 <- DimPlot(mb_sc_ref, group.by = "Subclass", label = TRUE, repel = TRUE) + ggtitle("scRNA MB atlas data - Subclass")
p3 <- DimPlot(mb_sc_ref, group.by = "TaxonomyRank1", label = TRUE, repel = TRUE) + ggtitle("scRNA MB atlas data - TaxonomyRank 1")
p4 <- DimPlot(mb_sc_ref, group.by = "TaxonomyRank4", label = TRUE, repel = TRUE) + ggtitle("scRNA MB atlas data - TaxonomyRank 4")
(p1 - p2) / (p3 - p4)
p4
```

## Label transfer

```{r label_transfer, fig.width=6, fig.height=4}
# find anchors
anchors <- FindTransferAnchors(reference = mb_sc_ref, query = snMB)

# transfer labels
predictions.sub <- TransferData(
  anchorset = anchors,
  refdata = mb_sc_ref$Subclass,
  verbose = FALSE
)
predictions.tax4 <- TransferData(
  anchorset = anchors,
  refdata = mb_sc_ref$TaxonomyRank4,
  verbose = FALSE
)

snMB_labeltransfer_Subclass <- AddMetaData(object = snMB, metadata = predictions.sub)
snMB_labeltransfer_TaxonomyRank4 <- AddMetaData(object = snMB, metadata = predictions.tax4)

DimPlot(snMB_labeltransfer_Subclass, reduction = "umap", group.by = "predicted.id", label = TRUE, repel = TRUE, label.size = 5, pt.size = 1) + ggtitle("SIMPlex snMB - label transfer (Mouse Brain Atlas)", subtitle = "Subclass") + guides(color=guide_legend(ncol =1))
DimPlot(snMB_labeltransfer_TaxonomyRank4, reduction = "umap", group.by = "predicted.id", pt.size = 1) + ggtitle("SIMPlex snMB - label transfer (Mouse Brain Atlas)", subtitle = "TaxonomyRank4") + guides(color=guide_legend(ncol =1))
```

```{r cell_type_cells_mini}
snMB_labeltransfer_Subclass <- SetIdent(snMB_labeltransfer_Subclass, value = "predicted.id")
snMB_labeltransfer_TaxonomyRank4 <- SetIdent(snMB_labeltransfer_TaxonomyRank4, value = "predicted.id")
pred.table.sub <- table(snMB_labeltransfer_Subclass$predicted.id)
pred.table.tax4 <- table(snMB_labeltransfer_TaxonomyRank4$predicted.id)
pred.table.sub
pred.table.tax4
```

## Label transfer with public cortex data (Allen)

```{r label_transfer_allen, warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
se.allen <- readRDS("/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/public_mb_data/allen_cortex.rds")

# perform standard preprocessing on each object
se.allen <- SCTransform(se.allen, vst.flavor="v2", verbose = FALSE)
se.allen <- FindVariableFeatures(se.allen, verbose = FALSE)
se.allen <- ScaleData(se.allen, verbose = FALSE)
se.allen <- RunPCA(se.allen, verbose = FALSE)
se.allen <- RunUMAP(se.allen, dims = 1:30, verbose = FALSE)

# find anchors
anchors <- FindTransferAnchors(reference = se.allen, query = snMB)

# transfer labels
predictions <- TransferData(
  anchorset = anchors,
  refdata = se.allen$subclass,
  verbose = FALSE
)

snMB_labeltransfer_allen_cortex <- AddMetaData(object = snMB, metadata = predictions)

DimPlot(se.allen, group.by = "subclass", label = TRUE) + ggtitle("Allen cortex data with annotation")
DimPlot(snMB_labeltransfer_allen_cortex, group.by = "predicted.id", label = TRUE, repel = TRUE) + ggtitle("snMB - label transfer", subtitle = "Allen Cortex")
```

```{r cell_type_cells_allen}
snMB_labeltransfer_allen_cortex <- SetIdent(snMB_labeltransfer_allen_cortex, value = "predicted.id")
table(snMB_labeltransfer_allen_cortex$predicted.id)
```

## Markers and dotplot for label transfered cell type annotations

```{r dotplot, fig.height=14, fig.width=14}
#Subclass
Idents(snMB_labeltransfer_Subclass) <- snMB_labeltransfer_Subclass$predicted.id
sn.markers.subclass <- FindAllMarkers(snMB_labeltransfer_Subclass, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, verbose = FALSE)
sn.markers.subclass %>% group_by(cluster) %>% slice_max(n = 5, order_by = avg_log2FC)
write.csv(sn.markers.subclass, "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/MB_2_top5_markers_subclass.csv", row.names = FALSE)

AllMarkers.F <- sn.markers.subclass %>%
  filter(p_val_adj < 0.01)

top5CL <- AllMarkers.F %>%
  group_by(cluster) %>%
  arrange(as.character(cluster)) %>%
  top_n(wt = avg_log2FC, n = 5)

DotPlot(snMB_labeltransfer_Subclass, 
        features = unique(top5CL$gene), 
        col.min = 0, 
        dot.min = 0, 
        dot.scale = 5,
        group.by = "predicted.id") + 
  RotatedAxis() + 
  xlab('Marker genes') + 
  ylab('Samples') + 
  scale_y_discrete(limits=rev) + 
  scale_x_discrete(position = "top") + 
  theme(text = element_text(size = 10), 
        axis.text.x=element_text(size=14),
        axis.text.x.top = element_text(margin = margin(b = 1), hjust = 0),
        axis.text.y=element_text(size=12), 
        legend.direction="horizontal", 
        legend.position = "top")

#Tax4
Idents(snMB_labeltransfer_TaxonomyRank4) <- snMB_labeltransfer_TaxonomyRank4$predicted.id
sn.markers.tax4 <- FindAllMarkers(snMB_labeltransfer_TaxonomyRank4, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, verbose = FALSE)
sn.markers.tax4 %>% group_by(cluster) %>% slice_max(n = 5, order_by = avg_log2FC)
write.csv(sn.markers.tax4, "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/MB_2_top5_markers_tax4.csv", row.names = FALSE)

AllMarkers.F <- sn.markers.tax4 %>%
  filter(p_val_adj < 0.01)

top5CL <- AllMarkers.F %>%
  group_by(cluster) %>%
  arrange(as.character(cluster)) %>%
  top_n(wt = avg_log2FC, n = 5)

DotPlot(snMB_labeltransfer_TaxonomyRank4, 
        features = unique(top5CL$gene), 
        col.min = 0, 
        dot.min = 0, 
        dot.scale = 8,
        group.by = "predicted.id") + 
  RotatedAxis() + 
  xlab('Marker genes') + 
  ylab('Samples') + 
  scale_y_discrete(limits=rev) + 
  scale_x_discrete(position = "top") + 
  theme(text = element_text(size = 10), 
        axis.text.x=element_text(size=14),
        axis.text.x.top = element_text(margin = margin(b = 1), hjust = 0),
        axis.text.y=element_text(size=14), 
        legend.direction="horizontal", 
        legend.position = "top")

#Allen
Idents(snMB_labeltransfer_allen_cortex) <- snMB_labeltransfer_allen_cortex$predicted.id
sn.markers.allen <- FindAllMarkers(snMB_labeltransfer_allen_cortex, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, verbose = FALSE)
sn.markers.allen %>% group_by(cluster) %>% slice_max(n = 5, order_by = avg_log2FC)
write.csv(sn.markers.allen, "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/MB_2_top5_markers_allen.csv", row.names = FALSE)

AllMarkers.F <- sn.markers.allen %>%
  filter(p_val_adj < 0.01)

top5CL <- AllMarkers.F %>%
  group_by(cluster) %>%
  arrange(as.character(cluster)) %>%
  top_n(wt = avg_log2FC, n = 5)

top5CL <- subset(top5CL, cluster %in% c("L2/3 IT", "L4", "L5 IT", "L5 PT", "L6 CT", "L6 IT", "L6b"))
snMB_labeltransfer_allen_cortex_subset <- subset(snMB_labeltransfer_allen_cortex, idents = c("L2/3 IT", "L4", "L5 IT", "L5 PT", "L6 CT", "L6 IT", "L6b"))

DotPlot(snMB_labeltransfer_allen_cortex_subset, 
        features = unique(top5CL$gene),
        col.min = 0, 
        dot.min = 0, 
        dot.scale = 8,
        group.by = "predicted.id") + 
  RotatedAxis() + 
  xlab('Marker genes') + 
  ylab('Samples') + 
  scale_y_discrete(limits=rev) + 
  scale_x_discrete(position = "top") + 
  theme(text = element_text(size = 10), 
        axis.text.x=element_text(size=14),
        axis.text.x.top = element_text(margin = margin(b = 1), hjust = 0),
        axis.text.y=element_text(size=12), 
        legend.direction="horizontal", 
        legend.position = "top")
```

## Save objects

```{r save, warning=FALSE, eval=FALSE}
saveRDS(snMB, file = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/snMB_2_cellbender.rds")
saveRDS(snMB_labeltransfer_Subclass, file = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/snMB_2_cellbender_labeltransfer_subclass.rds")
saveRDS(snMB_labeltransfer_TaxonomyRank4, file = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/snMB_2_cellbender_labeltransfer_tax4.rds")
saveRDS(snMB_labeltransfer_allen_cortex, file ="/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/snMB_2_cellbender_labeltransfer_allen_cortex.rds")

mb_sc_ref <- SetIdent(mb_sc_ref, value = "Subclass")
scMB_ref_subclass_downsample <- subset(mb_sc_ref, downsample = 1000)
mb_sc_ref <- SetIdent(mb_sc_ref, value = "TaxonomyRank4")
scMB_ref_tax4_downsample <- subset(mb_sc_ref, downsample = 1000)

saveRDS(scMB_ref_subclass_downsample, file = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/scMB_ref_subclass_downsampled.rds")
saveRDS(scMB_ref_tax4_downsample, file = "/home/st-analysis_home/mengxiao.he/SIMPlex/analysis/SIMPlex_MB/scMB_ref_tax4_downsampled.rds")
```

## Session info
```{r session_info}
sessionInfo()
```


